import {
  Examples,
  Input,
  Output,
  Figure,
  PostLayout,
  Simulators,
  Solution,
  Subtask,
} from "components";

export const meta = {
  title: "개미",
  year: 2024,
  stage: "본선",
};

export default ({ children }) => (
  <PostLayout meta={meta}>{children}</PostLayout>
);


$N$개의 방이 있는 개미집이 있다.
각 방에는 $1$번부터 $N$번까지 서로 다른 번호가 붙어 있다.
서로 다른 $2$개의 방을 잇는 굴이 $N - 1$개가 있다.
임의의 방에서 임의의 다른 방으로 하나 이상의 굴을 통해서 이동하는 것이 가능하다.

초기에 $i$번 방에는 $A_i$마리의 개미가 있다.
모든 방의 개미의 마리 수를 합하면 $N$, $N+1$, $N+2$ 중 하나의 값이 된다.

많은 수의 개미가 한 방에 모인 경우 생활 환경이 좋지 않기 때문에
각 방에 있는 개미의 수를 제한하고자 한다.
구체적으로, 모든 방에 있는 개미의 수가 $1$ 혹은 $2$가 되게 하는 것이 목표이다.
개미들은 굴을 따라 다른 방으로 자유롭게 이동할 수 있다.
각 개미가 이동한 거리는 거쳐간 굴의 개수로 정의된다.

목표를 달성하기 위해
개미들이 이동해야 하는 거리의 총합의 최소값을 구하는 프로그램을 작성하라.

## 입력 형식

첫 줄에 방의 개수를 나타내는 정수 $N$이 주어진다.
$(2 \le N \le 500\,000)$

그다음 줄에 초기에 각 방에 있는 개미의 마리 수를 나타내는 $N$개의 정수
$A_1, A_2, \cdots, A_N$이 공백으로 구분되어 차례대로 주어진다.
($A_i \ge 0$;
$A_1 + A_2 + \cdots + A_N$은 $N$, $N + 1$, $N + 2$ 중 하나와 같다.)

그다음 $N - 1$개의 줄에 걸쳐, 모든 굴의 정보가 주어진다.
각 줄에는 각 굴이 잇는 서로 다른 $2$개의 방 번호가 공백으로 구분되어 주어진다.

## 출력 형식

첫 줄에 개미들의 이동 거리의 총합의 최소값을 출력한다.


## 예제 1

<Examples>
  {/* prettier-ignore */}
  <Input>
5
0 1 2 0 2
1 2
1 3
2 4
2 5
  </Input>
  {/* prettier-ignore */}
  <Output>
3
  </Output>
</Examples>


## 예제 2

<Examples>
  {/* prettier-ignore */}
  <Input>
5
0 0 2 4 1
1 2
2 3
3 4
4 5
  </Input>
  {/* prettier-ignore */}
  <Output>
5
  </Output>
</Examples>

## 예제 설명

아래 그림은 두 번째 예제를 나타낸다.
각 방 위의 값은 방 번호이다.
그림의 **(a)** 는 초기에 각 방에 있는 개미의 수를 보여 준다.
그림의 **(a)** 에서 화살표는 목표를 달성하기 위해
개미 $2$마리가 이동한 것을 보여준다.
개미들이 이동을 마치고 나면 그림의 **(b)** 와 같이 되어 목표가 달성된다.
두 마리의 개미가 이동한 거리의 총합은 $5$이다.

<div style={{ display: "flex" }}>
  <Figure
    src="/2025/f-4-50962be7-46b4-44a1-b5fd-313a0328fc9c.png"
    width={1000}
  />
</div>

## 채점 방식

입력 케이스들은 다음과 같은 종류로 구별되며, 한 종류의 케이스를 다 맞혀야 그 종류에 배정된 점수를 받을 수 있다.

<Subtask index={1} score={13}>
  $i$번째 굴은 $i$번 방과 $i+1$번 방을 연결하는 굴이다. $(1 \le i \le N - 1)$
</Subtask>
<Subtask index={2} score={9}>
  $N \le 500$
</Subtask>
<Subtask index={3} score={7}>
  $N \le 5\,000$
</Subtask>
<Subtask index={4} score={12}>
  모든 방의 개미 수의 총합은 $N$이다.
</Subtask>
<Subtask index={5} score={21}>
  모든 방의 개미 수의 총합은 $N + 1$이다.
</Subtask>
<Subtask index={6} score={38}>
  모든 입력 케이스가 주어진다.
</Subtask>

## 해설

<Solution>
트리의 각 정점 $v$에 대해, 그 서브트리에 포함된 개미 수와 서브트리 크기의 차이를 $T[v]$라 합시다. 이는 해당 서브트리에 개미가 얼마나 남거나 부족한지를 나타내며, $T[v] > 0$이면 그만큼의 개미가 부모 쪽으로 이동하고, $T[v] < 0$이면 부모로부터 개미가 들어와야 합니다.

총 개미 수가 $S = N$일 때, $v$와 $v$의 부모를 잇는 간선을 따라 이동하는 개미 수는 $|T[v]|$이므로 전체 최소 이동 거리는 $\sum |T[v]|$가 됩니다.

$S = N + 1$일 때는 정확히 한 정점만 개미를 두 마리 가져야 합니다. 어떤 정점을 $x$로 정했을 때, 루트에서 $x$까지의 경로에 있는 간선들의 이동량만 변합니다. 각 간선의 변화량을 $|T[v]-1| - |T[v]|$라 하면, 이를 루트에서 $x$까지 누적한 $D(x) = \sum_{v \in \text{path}(root\to x)} (|T[v]-1| - |T[v]|)$이 “정점 $x$에 개미를 한 마리 더 두었을 때 절약되는 이동 거리”가 됩니다. 따라서 이 경우의 최소 이동 거리는 $\sum |T[v]| - \max_x D(x)$로 구할 수 있습니다.

마지막으로 $S = N + 2$인 경우에는 두 정점에 개미를 두 마리씩 둬야 합니다. 두 정점을 $x, y$, 그들의 최소 공통 조상을 $l$이라고 하면, 루트에서 $l$까지의 경로는 두 마리의 개미가 모두 지나가므로 이동량이 2만큼 증가하고, $l$에서 $x, y$로 내려가는 두 갈래 경로에서는 각각 1만큼 증가합니다.

이 성질을 이용하면, 각 정점을 공통 조상 후보로 두고 생각했을 때, 그 정점의 서로 다른 두 자식(또는 자기 자신 포함)에서 얻을 수 있는 “개미를 한 마리 더 남겼을 때의 절약 효과”를 각각 구해 두 개를 더한 뒤, 공통 구간의 중복 부분을 한 번만 반영하도록 보정하면 답을 구할 수 있습니다.

위의 모든 과정은 여러 번의 DFS를 통해 필요한 값을 구할 수 있으므로, 전체 시간복잡도 $O(N)$에 문제를 해결할 수 있습니다.
</Solution>
